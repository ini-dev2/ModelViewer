<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Unity Park</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- model-viewer -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}

model-viewer {
    width: 100vw;
    height: 100vh;
    position: fixed;
    inset: 0;
    z-index: 1;
    background-color: #f0f0f0;
}

/* Стили для хотспотов */
.Hotspot {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    color: #333;
    display: block;
    font-size: 12px;
    font-weight: 600;
    padding: 8px 12px;
    position: absolute;
    width: max-content;
    height: max-content;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
}

.Hotspot:hover {
    background: rgba(255, 255, 255, 1);
    transform: scale(1.05);
}

.Hotspot span {
    display: inline-block;
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
    font-weight: bold;
}

/* Панорамный оверлей */
#panorama-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.98);
    z-index: 1000;
    display: none;
    flex-direction: column;
}

#panorama-overlay.active {
    display: flex;
}

/* Header */
.panorama-header {
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    background: rgba(0,0,0,0.9);
    color: white;
    flex-shrink: 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.close-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: white;
    font-size: 22px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
}

.close-btn:hover {
    background: rgba(255,255,255,0.2);
}

#panorama-title {
    font-size: 18px;
    font-weight: 500;
}

/* Контейнер под WebGL */
#panorama-canvas-container {
    flex: 1;
    position: relative;
    width: 100%;
    height: calc(100vh - 56px);
}

#panorama-canvas-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
}

/* Сообщение об ошибке */
#error-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    text-align: center;
    display: none;
}

/* Индикатор загрузки */
.loading-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 16px;
    z-index: 10;
}

.loading-indicator::after {
    content: '';
    display: block;
    width: 40px;
    height: 40px;
    margin: 10px auto;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<!-- MODEL VIEWER -->
<model-viewer
    id="model-viewer"
    src="models/UnityParkOptimized.glb"
    camera-controls
    touch-action="none"
    shadow-intensity="1"
    field-of-view="45deg"
    min-camera-orbit="auto auto 5%"
    camera-orbit="-10deg -45deg 5m"
    ar
>
    <button slot="ar-button">AR-режим</button>
    
    <button
        class="Hotspot"
        slot="hotspot-1"
        data-position="-0.9073734110678933m 0.1507534682750702m -0.2609223591867831m"
        data-normal="0m 1m 0m"
        data-target="-0.9073734110678933m 0.1507534682750702m -0.2609223591867831m"
        data-orbit="0deg 30deg 0.6m"
        data-visibility-attribute="visible"
        data-panorama="https://pannellum.org/images/alma.jpg"
    >
        Конгрессно-выставочный центр <span>360°</span>
    </button>
</model-viewer>

<!-- PANORAMA OVERLAY -->
<div id="panorama-overlay">
    <div class="panorama-header">
        <span id="panorama-title">360° Панорама</span>
        <button id="close-panorama" class="close-btn">✕</button>
    </div>
    <div id="panorama-canvas-container">
        <div class="loading-indicator"></div>
        <div id="error-message"></div>
    </div>
</div>

<!-- MAIN SCRIPT -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';

// КЛАСС ДЛЯ 360° ПАНОРАМЫ
// КЛАСС ДЛЯ 360° ПАНОРАМЫ
class PanoramaViewer {
    constructor(containerId) {
        // Элемент-контейнер
        this.container = document.getElementById(containerId);

        // Сцена
        this.scene = new THREE.Scene();

        // Камера
        this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        this.camera.position.set(0, 0, 0.1); // небольшое смещение вперед

        // Создаем pivot-группу для горизонтального вращения
        this.cameraPivot = new THREE.Object3D();
        this.cameraPivot.add(this.camera);
        this.scene.add(this.cameraPivot);

        // Рендерер и меш пока null
        this.renderer = null;
        this.sphere = null;

        // Переменные для управления мышью/тачем
        this.isDragging = false;
        this.previousMousePosition = { x: 0, y: 0 };

        // Инициализация рендерера, света и сцены
        this.init();

        // Подключение событий мыши/тача
        this.bindEvents();

        // Анимация рендера
        this.animate();
    }
    
    init() {
        // Создаем рендерер
        this.renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            alpha: true 
        });
        
        this.updateSize();
        this.container.appendChild(this.renderer.domElement);
        
        // Настраиваем камеру
        this.camera.position.set(0, 0, 0.1);
        
        // Добавляем свет
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
        this.scene.add(ambientLight);
        
        console.log('PanoramaViewer initialized');
    }
    
    updateSize() {
        const width = this.container.clientWidth;
        const height = this.container.clientHeight;
        
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(width, height);
        this.renderer.setPixelRatio(window.devicePixelRatio);
    }
    
    loadPanorama(url) {
        console.log('Loading panorama from:', url);
        
        // Показываем индикатор загрузки
        this.showLoading();
        
        const loader = new THREE.TextureLoader();
        
        loader.load(
            url,
            (texture) => {
                console.log('Panorama texture loaded successfully');
                
                // Скрываем индикатор загрузки
                this.hideLoading();
                
                // Очищаем предыдущую сферу
                if (this.sphere) {
                    this.scene.remove(this.sphere);
                }
                
                // Настраиваем текстуру
                texture.colorSpace = THREE.SRGBColorSpace;
                texture.wrapS = THREE.RepeatWrapping;
                texture.repeat.x = -1; // Инвертируем для правильной ориентации
                
                // Создаем геометрию сферы
                const geometry = new THREE.SphereGeometry(100, 60, 40);
                
                // Инвертируем нормали (чтобы текстура отображалась внутри сферы)
                geometry.scale(-1, 1, 1);
                
                // Создаем материал
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    side: THREE.DoubleSide
                });
                
                // Создаем меш
                this.sphere = new THREE.Mesh(geometry, material);
                
                // Добавляем в сцену
                this.scene.add(this.sphere);
                
                console.log('Panorama sphere created and added to scene');
            },
            (xhr) => {
                // Прогресс загрузки
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            (error) => {
                console.error('Error loading panorama:', error);
                this.hideLoading();
                this.showError('Ошибка загрузки панорамы. Проверьте URL и CORS.');
            }
        );
    }
    
    showLoading() {
        const loading = this.container.querySelector('.loading-indicator');
        if (loading) {
            loading.style.display = 'block';
        }
        
        const error = this.container.querySelector('#error-message');
        if (error) {
            error.style.display = 'none';
        }
    }
    
    hideLoading() {
        const loading = this.container.querySelector('.loading-indicator');
        if (loading) {
            loading.style.display = 'none';
        }
    }
    
    showError(message) {
        const error = this.container.querySelector('#error-message');
        if (error) {
            error.textContent = message;
            error.style.display = 'block';
        }
    }
    
    bindEvents() {
        // Обработка мыши
        this.container.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            this.previousMousePosition = {
                x: e.clientX,
                y: e.clientY
            };
            this.container.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!this.isDragging) return;
            
            const deltaMove = {
                x: e.clientX - this.previousMousePosition.x,
                y: e.clientY - this.previousMousePosition.y
            };
            
            // Вращаем камеру
            this.rotateCamera(deltaMove.x * 0.005, deltaMove.y * 0.005);
            
            this.previousMousePosition = {
                x: e.clientX,
                y: e.clientY
            };
        });
        
        document.addEventListener('mouseup', () => {
            this.isDragging = false;
            this.container.style.cursor = 'grab';
        });
        
        // Обработка сенсорного ввода
        this.container.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                this.isDragging = true;
                this.previousMousePosition = {
                    x: e.touches[0].clientX,
                    y: e.touches[0].clientY
                };
                e.preventDefault();
            }
        }, { passive: false });
        
        this.container.addEventListener('touchmove', (e) => {
            if (!this.isDragging || e.touches.length !== 1) return;
            
            const deltaMove = {
                x: e.touches[0].clientX - this.previousMousePosition.x,
                y: e.touches[0].clientY - this.previousMousePosition.y
            };
            
            this.rotateCamera(deltaMove.x * 0.01, deltaMove.y * 0.01);
            
            this.previousMousePosition = {
                x: e.touches[0].clientX,
                y: e.touches[0].clientY
            };
            
            e.preventDefault();
        }, { passive: false });
        
        this.container.addEventListener('touchend', () => {
            this.isDragging = false;
        });
        
        // Изменение размера окна
        window.addEventListener('resize', () => {
            this.updateSize();
        });
    }
    
    rotateCamera(deltaX, deltaY) {
    if (!this.sphere) return;

    const rotationSpeed = 0.5;

    // Горизонтальное вращение через pivot
    this.cameraPivot.rotation.y += deltaX * rotationSpeed;

    // Вертикальное вращение камеры
    this.camera.rotation.x += deltaY * -1 * rotationSpeed;

    // Ограничение вертикального наклона (чтобы не перевернуться)
    this.camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, this.camera.rotation.x));

    // Дополнительно можно нормализовать Y, но теперь pivot контролирует горизонталь
}
    
    animate() {
        requestAnimationFrame(() => this.animate());
        this.renderer.render(this.scene, this.camera);
    }
}

// ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, initializing...');
    
    // Элементы DOM
    const overlay = document.getElementById('panorama-overlay');
    const closeBtn = document.getElementById('close-panorama');
    const panoramaViewer = new PanoramaViewer('panorama-canvas-container');
    
    // Назначаем обработчики клика на хотспоты
    document.querySelectorAll('.Hotspot').forEach(hotspot => {
        hotspot.addEventListener('click', (e) => {
            e.stopPropagation();
            
            const panoramaUrl = hotspot.dataset.panorama;
            if (!panoramaUrl) {
                console.warn('No panorama URL specified for hotspot');
                return;
            }
            
            console.log('Opening panorama:', panoramaUrl);
            
            // Устанавливаем заголовок
            const title = hotspot.textContent.replace('360°', '').trim();
            document.getElementById('panorama-title').textContent = title + ' - 360° Панорама';
            
            // Загружаем панораму
            panoramaViewer.loadPanorama(panoramaUrl);
            
            // Показываем оверлей
            overlay.classList.add('active');
            
            // Обновляем размеры при показе
            setTimeout(() => {
                panoramaViewer.updateSize();
            }, 100);
        });
    });
    
    // Кнопка закрытия
    closeBtn.addEventListener('click', () => {
        overlay.classList.remove('active');
        console.log('Panorama closed');
    });
    
    // Закрытие по клавише ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay.classList.contains('active')) {
            overlay.classList.remove('active');
        }
    });
    
    // Закрытие по клику вне контента (опционально)
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.classList.remove('active');
        }
    });
    
    // Дебаг информация
    console.log('Hotspots found:', document.querySelectorAll('.Hotspot').length);
    console.log('Initialization complete');
});

// Обработка ошибок загрузки
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    console.error('Error in file:', e.filename, 'line:', e.lineno);
});

</script>

</body>
</html>